<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QP State Machine (RC)</title>
  <link rel="stylesheet" href="shared.css" />
</head>
<body>
  <div class="wrap">
    <h1>QP State Machine (RC)</h1>
    <p class="sub">
      RC QPs move through RESET → INIT → RTR → RTS. CM packets negotiate the contract; data flows only after RTS.
    </p>

    <div class="grid">
      <div class="card">
        <div class="canvasWrap">
          <canvas id="c"></canvas>
        </div>
      </div>

      <div class="card controls">
        <div class="ctl">
          <label><span>Speed</span><strong><span id="speedVal">1.0x</span></strong></label>
          <input id="speed" type="range" min="0.4" max="2.0" step="0.1" value="1.0" />
        </div>

        <div class="ctl">
          <label><span>Mode</span><span class="pill" id="modeLabel">CM Handshake</span></label>
          <div class="tog">
            <div class="btn primary" id="modeCM">CM Handshake</div>
            <div class="btn" id="modeData">Data Plane</div>
          </div>
        </div>

        <div class="ctl">
          <div class="tog">
            <div class="btn primary" id="toggleRun">Pause</div>
            <div class="btn" id="step">Step</div>
            <div class="btn danger" id="reset">Reset</div>
          </div>
          <div class="kv">
            <span>State</span><strong><span id="state">RESET</span></strong>
            <span>Phase</span><strong><span id="phase">Negotiating</span></strong>
          </div>
        </div>
      </div>
    </div>
  </div>

<script src="shared.js"></script>
<script>
(() => {
  const { ctx } = SimUI.setupCanvas('c');

  const el = {
    speed: document.getElementById('speed'),
    speedVal: document.getElementById('speedVal'),
    modeCM: document.getElementById('modeCM'),
    modeData: document.getElementById('modeData'),
    modeLabel: document.getElementById('modeLabel'),
    toggleRun: document.getElementById('toggleRun'),
    step: document.getElementById('step'),
    reset: document.getElementById('reset'),
    state: document.getElementById('state'),
    phase: document.getElementById('phase'),
  };

  const bindRange = SimUI.bindRange;
  bindRange(el.speed, el.speedVal, v => `${Number(v).toFixed(1)}x`);

  const states = [
    { name: 'RESET', desc: 'Nothing trusted' },
    { name: 'INIT', desc: 'Local intent set' },
    { name: 'RTR', desc: 'Remote known' },
    { name: 'RTS', desc: 'Ready to send' },
  ];

  let running = true;
  let stepMode = false;
  let idx = 0;
  let t = 0;
  let mode = 'cm';

  function setMode(m) {
    mode = m;
    el.modeLabel.textContent = m === 'cm' ? 'CM Handshake' : 'Data Plane';
    el.modeCM.classList.toggle('primary', m === 'cm');
    el.modeData.classList.toggle('primary', m !== 'cm');
  }

  el.modeCM.onclick = () => setMode('cm');
  el.modeData.onclick = () => setMode('data');

  el.toggleRun.onclick = () => {
    running = !running;
    el.toggleRun.textContent = running ? 'Pause' : 'Play';
  };

  el.step.onclick = () => {
    idx = (idx + 1) % states.length;
    t = 0;
  };

  el.reset.onclick = () => {
    idx = 0;
    t = 0;
  };

  function tick() {
    if (running) {
      const speed = Number(el.speed.value);
      t += 0.016 * speed;
      if (t > 1.6) {
        idx = (idx + 1) % states.length;
        t = 0;
      }
    }

    const w = ctx.canvas.width / (window.devicePixelRatio || 1);
    const h = ctx.canvas.height / (window.devicePixelRatio || 1);
    ctx.clearRect(0, 0, w, h);
    ctx.fillStyle = '#0d1117';
    ctx.fillRect(0, 0, w, h);

    const centerX = w / 2;
    const baseY = h / 2 - 20;

    states.forEach((s, i) => {
      const x = centerX - 240 + i * 160;
      const active = i === idx;
      ctx.fillStyle = active ? '#4da3ff' : 'rgba(255,255,255,0.08)';
      ctx.fillRect(x, baseY, 120, 50);
      ctx.fillStyle = active ? '#0b0d10' : '#a7b3c5';
      ctx.font = '12px system-ui, sans-serif';
      ctx.fillText(s.name, x + 38, baseY + 30);
    });

    ctx.strokeStyle = 'rgba(255,255,255,0.15)';
    ctx.beginPath();
    ctx.moveTo(centerX - 180, baseY + 25);
    ctx.lineTo(centerX + 180, baseY + 25);
    ctx.stroke();

    const cur = states[idx];
    el.state.textContent = cur.name;
    el.phase.textContent = mode === 'cm' ? 'Negotiating' : 'Transferring';

    ctx.fillStyle = '#a7b3c5';
    ctx.font = '12px system-ui, sans-serif';
    ctx.fillText(cur.desc, centerX - 60, baseY + 90);

    if (mode === 'cm') {
      ctx.fillStyle = '#ffb020';
      ctx.fillRect(centerX - 40, baseY - 50, 80, 20);
      ctx.fillStyle = '#0b0d10';
      ctx.fillText('CM', centerX - 8, baseY - 36);
    } else {
      ctx.fillStyle = '#6ee7b7';
      ctx.fillRect(centerX - 60, baseY - 50, 120, 20);
      ctx.fillStyle = '#0b0d10';
      ctx.fillText('DATA', centerX - 14, baseY - 36);
    }

    requestAnimationFrame(tick);
  }

  setMode('cm');
  requestAnimationFrame(tick);
})();
</script>
</body>
</html>
